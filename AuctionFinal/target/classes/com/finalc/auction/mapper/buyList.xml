<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #26. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- ==== #27. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="buyList">
	<!-- #Buy 7. 구매 리스트 xml 단 -->
	
	<resultMap type="HashMap" id="getBuyListMap">
		<result property="AWARDNUM" column="awardnum" javaType="String" />
		<result property="AWARDDAY" column="awardday" javaType="String" />
		<result property="AWARDPRICE" column="awardprice" javaType="String" />
		<result property="CNAME" column="cname" javaType="String" />
		<result property="CDNAME" column="cdname" javaType="String" />
		<result property="ACTNAME" column="actname" javaType="String" />
		<result property="PANMAEJA" column="panmaeja" javaType="String" />
		<result property="DELIVERSTATUS" column="deliverstatus" javaType="String" />
		<result property="CNUM" column="cnum" javaType="String" />
		<result property="CDNUM" column="cdnum" javaType="String" />
		<result property="ACTNUM" column="actnum" javaType="String" />
		<result property="ACTDNUM" column="actdnum" javaType="String" />
		<result property="ACTIMAGE" column="actimage" javaType="String" />
		
	</resultMap>
	
	<select id="getBuyList" parameterType="HashMap" resultMap="getBuyListMap">
		<!-- select awardnum, cname, cdname, actname
		     , to_char(awardday, 'yyyy-mm-dd') AS awardday, awardprice
		from tbl_category A join tbl_category_detail B
		on A.cnum = B.fk_cnum
		join tbl_auction C
		on B.cdnum = C.fk_cdnum
		join tbl_auction_detail D
		on C.actnum = D.fk_actnum
		join tbl_award E
		on D.actdnum = E.fk_actdnum
		where E.fk_usernum = to_number(#{usernum}) and actd_status = 1
		order by awardnum desc -->
		  select awardnum
		       , awardday
		       , awardprice
		       , cname, cdname, actname, panmaeja
		       , deliverstatus, cnum, cdnum, actnum, actdnum
		       , actimage
		  from 
		  (
		  select rownum AS RNO, awardnum
		     , to_char(awardday, 'yyyy-mm-dd') AS awardday
		     , awardprice
		       , cname, cdname, actname, panmaeja
		       , deliverstatus, cnum, cdnum, actnum, actdnum
		       , actimage
		  from 
		  (select cnum, cname, cdnum, cdname
		       , actnum, actname, actimage
		       , actdnum, fk_usernum, actd_price, actd_qty, actd_status, actd_content, actd_lowertenderprice
		       , to_char(actd_startday, 'yyyy-mm-dd') AS actd_startday
		       , to_char(actd_endday, 'yyyy-mm-dd') AS actd_endday
		       , E.fk_userid AS panmaeja
		  from tbl_category A join tbl_category_detail B
		  on A.cnum = B.fk_cnum
		  join tbl_auction C
		  on B.cdnum = C.fk_cdnum
		  join tbl_auction_detail D
		  on C.actnum = D.fk_actnum
		  join tbl_member_detail E
		  on D.fk_usernum = E.usernum
		  )V
		  right join tbl_award F
		  on V.actdnum = F.fk_actdnum
		  join tbl_deliver G
		  on F.awardnum = G.fk_awardnum
		  where F.fk_usernum = #{usernum} and V.actd_status = 1
		  order by awardnum desc
		  )T
		  where T.RNO >= #{startRno} and T.RNO <![CDATA[<=]]> #{endRno} 
	</select>
	
	<select id="getTotalCount" resultType="Integer">
		select count(*)
		from tbl_award
	</select>
</mapper>