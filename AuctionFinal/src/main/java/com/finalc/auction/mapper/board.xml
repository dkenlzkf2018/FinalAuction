<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 

<!-- 게시판 xml -->

<!-- ==== 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="board">

<!-- 검색어가 없는 총게시물 건수 07.03 시작 -->
	<select id="getTotalCount" resultType="Integer">
		select count(*)
		from tbl_board
		where boardstatus = 1
	</select>
<!-- 검색어가 없는 총게시물 건수 07.03 끝-->

<!-- 검색어가 있는 총게시물 건수 07.03 시작 -->
	<select id="getTotalCount2" parameterType="HashMap" resultType="Integer">
		select count(*)
		from tbl_board
		where boardstatus = 1
		and ${colname} like '%'|| #{search} ||'%'
	</select>
<!-- 검색어가 있는 총게시물 건수 07.03 끝-->

<!-- // 검색어 없는 게시글목록 보여주기 시작 07.03 -->
	<select id="boardList" parameterType="HashMap" resultType="com.finalc.auction.model.BoardVO">
	select boardno, fk_userid, subject, viewcount, writeday, commentcount, fk_boardno
	from 
	(
	select rownum as RNO
	     , V.boardno, V.fk_userid, V.subject, V.content, V.viewcount, V.writeday, V.commentcount, V.fk_boardno
	from 
	(
	select boardno, fk_userid 
	     , case when length(subject) > 20 then substr(subject, 1, 18)||'..'
	            else subject end as subject
	     , content , viewcount
	     , to_char(writeday, 'yyyy-mm-dd hh24:mi:ss') as writeday
	     , commentcount, fk_boardno
	from tbl_board
	where boardstatus = 1
	order by boardno desc
	) V
	) T
	where T.RNO >= #{startRno} and T.RNO <![CDATA[<=]]> #{endRno} 
	</select>
<!-- // 검색어 없는 게시글목록 보여주기 시작 07.03 -->
	
<!-- // 검색어 있는 게시글목록 보여주기 시작 07.03 -->
	<select id="boardList2" parameterType="HashMap" resultType="com.finalc.auction.model.BoardVO">
	select  boardno, fk_userid, subject, viewcount, writeday, commentcount
              , groupno, fk_boardno, deptthno
              , fileName, orgFilename, fileSize 
		from 
		(
		   select rownum as RNO
		        , V.boardno, V.fk_userid, V.subject, V.content, V.viewcount, V.writeday, V.commentcount
                , V.groupno, V.fk_boardno, V.deptthno
                , V.fileName, V.orgFilename, V.fileSize 
		   from 
		   (
		     select boardno, fk_userid 
		          , case when length(subject) > 20 then substr(subject, 1, 18)||'..'
		            else subject end as subject
		          , content , viewcount
		          , to_char(writeday, 'yyyy-mm-dd hh24:mi:ss') as writeday
		          , commentcount
                  , groupno, fk_boardno, deptthno
                  , fileName, orgFilename, fileSize 
		     from tbl_board
		     where boardstatus = 1
		           and ${colname} like '%'|| #{search} ||'%'
		     start with fk_boardno = 0
             connect by prior boardno = fk_boardno
		     order siblings by groupno desc, fk_boardno asc
		   ) V
		) T
		where T.RNO >= #{startRno} and T.RNO <![CDATA[<=]]> #{endRno} 
	</select>
<!-- // 검색어 있는 게시글목록 보여주기 끝 07.03 -->

<!-- 게시글 쓰기 스마트에디터 사용전 시작 07.03 -->
	<insert id="write_add" parameterType="com.finalc.auction.model.BoardVO">
	    <if test='fk_boardno.equals("")'>
		   insert into tbl_board(boardno, fk_userid, subject, content, viewcount, writeday, boardstatus, groupno, fk_boardno, deptthno)  
		   values(seq_board.nextval, #{fk_userid}, #{subject}, #{content}, default, default, default, #{groupno}, default, default) 
		</if> 
		<if test='!fk_boardno.equals("")'>
		  insert into tbl_board(boardno, fk_userid, subject, content, viewcount, writeday, boardstatus, groupno, fk_seq, deptthno)  
		  values(seq_board.nextval, #{fk_userid}, #{subject}, #{content}, default, default, default, #{groupno}, #{fk_boardno}, #{deptthno}+1) 
		</if>	
	</insert>
<!-- 게시글 쓰기 스마트에디터 사용전 끝 07.03 -->
	
	<select id="getGroupMaxno" resultType="Integer">
	    select nvl(max(groupno), 0)
		from tbl_board
	</select>

<!-- 게시글 쓰기 스마트에디터 사용 시작 07.04 -->
	<insert id="write_withFile" parameterType="com.finalc.auction.model.BoardVO">
	    <if test='fk_boardno.equals("")'>
		  insert into tbl_board(boardno, fk_userid, subject, content, viewcount, writeday, boardstatus, groupno, fk_boardno, deptthno, fileName, orgFilename, fileSize)  
		  values(seq_board.nextval, #{fk_userid}, #{subject}, #{content}, default, default, default, #{groupno}, default, default, #{fileName}, #{orgFilename}, #{fileSize}) 
		</if> 
		<if test='!fk_boardno.equals("")'>
		  insert into tbl_board(boardno, fk_userid, subject, content, viewcount, writeday, boardstatus, groupno, fk_boardno, deptthno, fileName, orgFilename, fileSize)  
		  values(seq_board.nextval, #{fk_userid}, #{subject}, #{content}, default, default, default, #{groupno}, #{fk_boardno}, #{deptthno}+1, #{fileName}, #{orgFilename}, #{fileSize})     
		</if>	
	</insert>
<!-- 게시글 쓰기 스마트에디터 사용 끝 07.04 -->

<!-- 게시글 1개보기 (조회수 증가, 증가없이 07.05 시작) -->
	<select id="getWriteView" parameterType="String" resultType="com.finalc.auction.model.BoardVO">
		select boardno, fk_userid, subject, content, viewcount,
			   to_char(writeday, 'yyyy-mm-dd hh24:mi:ss') as writeday, groupno,
			   fk_boardno, deptthno, fileName, orgFilename, fileSize
		from tbl_board
		where boardstatus = 1 and boardno = #{boardno}
	</select>
<!-- 게시글 1개보기 (조회수 증가, 증가없이 07.05 끝) -->

<!-- 게시글 1개 볼때마다 1증가(07.05 시작) -->
	<update id="setAddViewCount" parameterType="String">
		update tbl_board set viewcount = viewcount + 1
		where boardstatus = 1 and boardno = #{boardno}
	</update>
<!-- 게시글 1개 볼때마다 1증가(07.05 끝) -->

<!-- 댓글보기 (07.05 시작) -->
	<select id="commentList" parameterType="String" resultType="com.finalc.auction.model.CommentVO">
		select commentno, fk_userid, cm_content, 
	   		   to_char(cm_writeday, 'yyyy-mm-dd hh24:mi:ss') as cm_writeday,
	           fk_boardno, cm_status
		from tbl_comment
		where fk_boardno = #{boardno}
	</select>
<!-- 댓글보기 (07.05 끝) -->
	
	<select id="getReviewByActdnum" parameterType="String" resultType="com.finalc.auction.model.HugiBoardVO">
		select ep_boardno, fk_userid, fk_actdnum, ep_content, to_char(ep_writeday, 'yyyy-mm-dd hh24:mi:ss') as ep_writeday, ep_satisfaction, ep_boardstatus
		from tbl_hugiboard
		where fk_actdnum = #{actdnum}
	</select>
	
	<insert id="reviewRegist" parameterType="HashMap">
		insert into tbl_hugiboard(ep_boardno, fk_userid, fk_actdnum, ep_content, ep_writeday, ep_satisfaction, ep_boardstatus)
		values(seq_hugiboard.nextval, #{fk_userid}, #{actdnum}, #{ep_content}, default, #{ep_satisfaction*2}, default)
	</insert>

</mapper>